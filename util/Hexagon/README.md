# Hexagon/Halide Instrumentation

Adds timing and reporting to Hexagon code generated by a Halide Generator.

## Input Files
`instrumented_generator.h`
`profiling.cpp`
`logcat2json.cpp`

## Building
For now, build `profiling.cpp` with your DSP code. Later we will likely include this precompiled binary.

```
	hexagon-clang++ -std=c++17 -Igenerated -fPIC profiling.cpp -c -o profiling.o
```

Then link `profiling.o` with `lib${MY_LIB}_skel.so`.

To build `logcat2json`, from the source root directory:
```
    mkdir build
    cmake -B ./build -S . && cmake --build ./build
```

## Profiling
1. Include the header `instrumented_generator.h` in your Halide generator source.

2. Change the generators inheritance from

```
class MyGenerator : public Generator<MyGenerator>
```

to
```
class MyGenerator : public InstrumentedGenerator<MyGenerator>
```

All loops will be instrumented by default. 

3. Run the kernel and pipe logcat output into `logcat2json`

```
adb logcat | logcat2json
```

For detailed usage of `logcat2json`, refer to the program help.

## Reporting
JSON files created with `logcat2json` can be input into the scripts contained in the `reports` directory.

Summaries can be created in JSON or CSV using `summary`,
and Graphviz dotfiles with heatmap overlays can be generated with `cfgdot`.

Data for plotting can be extracted in batches using the `jsons2csv` tool.

Detailed usage instructions are contained in each tool's program help, accessible with the `-h` flag.
